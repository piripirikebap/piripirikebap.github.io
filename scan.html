<html lang="pl"><head><link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiIiwic2hvcnRfbmFtZSI6IiIsInRoZW1lX2NvbG9yIjoiIzEwMTMxNyIsImJhY2tncm91bmRfY29sb3IiOiIjMTAxMzE3IiwiZGlzcGxheSI6InN0YW5kYWxvbmUifQ==">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>mObywatel</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/app/main.css">
    <link rel="stylesheet" href="assets/app/scan.css">

    <!-- Ikony -->
    <link rel="icon" type="image/x-icon" href="assets/app/logo.png">
    <link rel="apple-touch-icon" href="assets/app/logo.png">
    <link rel="shortcut icon" href="assets/app/logo.png">

    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Zewnƒôtrzna biblioteka -->
    <script src="assets/app/html5-qrcode.min.js"></script><link type="text/css" rel="stylesheet" id="dark-mode-custom-link"><link type="text/css" rel="stylesheet" id="dark-mode-general-link"><style lang="en" type="text/css" id="dark-mode-custom-style"></style><style lang="en" type="text/css" id="dark-mode-native-style"></style><style lang="en" type="text/css" id="dark-mode-native-sheet"></style>
<style>:is([id*='google_ads_iframe'],[id*='taboola-'],.taboolaHeight,.taboola-placeholder,#top-ad,#credential_picker_container,#credentials-picker-container,#credential_picker_iframe,[id*='google-one-tap-iframe'],#google-one-tap-popup-container,.google-one-tap__module,.google-one-tap-modal-div,#amp_floatingAdDiv,#ez-content-blocker-container) {display:none!important;min-height:0!important;height:0!important;}</style></head>
<body>
    <div class="top_grid_fixed">
        <div class="action_grid_fixed">
            <img src="assets/app/images/back_blue.png" class="back_img_fixed">
            <p onclick="sendTo('qr.html')" class="back_text_fixed">Kod QR</p>
        </div>
        <p class="title_text_fixed">Zeskanuj kod QR</p>
        <img src="assets/app/images/help.png" class="help_img_fixed">
    </div>

    <div class="container">
        <p class="description">Umie≈õƒá kod QR w ramce, aby go zeskanowaƒá.</p>
        
        <div class="scan-frame">
            <div class="warning-box">
                <div class="warning-content">
                    <span class="warning-icon">!</span>
                    <p class="warning-text">Upewnij siƒô, ≈ºe kod QR pochodzi z wiarygodnego ≈∫r√≥d≈Ça.</p>
                    <span class="warning-close">√ó</span>
                </div>
            </div>
            <div id="reader" style="position: relative;"></div>
            <div class="frame-border">
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </div>
        </div>

        <button class="manual-input">Wpisz kod</button>
    </div>

    <div class="error">
        <div class="opacity"></div>
        <div class="error_box" style="display: none;">
        </div>
    </div>

    <div class="bottom_bar">
        <div class="bottom_bar_grid">
            <div class="bottom_element_grid" send="documents.html">
                <div class="bottom_element_image documents"></div>
                <p class="bottom_element_text">Dokumenty</p>
            </div>
            <div class="bottom_element_grid" send="services.html">
                <div class="bottom_element_image services"></div>
                <p class="bottom_element_text">Us≈Çugi</p>
            </div>
            <div class="bottom_element_grid" send="qr.html">
                <div class="bottom_element_image qr qr_open"></div>
                <p class="bottom_element_text open">Kod QR</p>
            </div>
            <div class="bottom_element_grid" send="more.html">
                <div class="bottom_element_image more"></div>
                <p class="bottom_element_text">Wiƒôcej</p>
            </div>
        </div>
    </div>

    <div class="code-input-container">
        <div class="code-input-overlay"></div>
        <div class="code-input-box">
            <div class="code-input-header">
                <span class="code-input-title">Kod</span>
                <span class="code-input-close" onclick="closeCodeInput()">Zamknij</span>
            </div>
            <p class="code-input-subtitle">Wpisz lub wklej kod.</p>
            <div class="code-input-field-container">
                <input type="number" class="code-input-field" placeholder=" " maxlength="6">
            </div>
            <button class="code-input-submit" onclick="submitCode()" disabled="disabled">Dalej</button>
        </div>
    </div>

    <!-- JS -->
    <script src="assets/app/bar.js"></script>
<script src="assets/app/bar.js"></script>
<script>
let html5QrCode = null;
let useBackCamera = true; // domy≈õlnie tylna kamera

function onScanSuccess(decodedText) {
  postJson('/qr/validate', { qrCode: decodedText })
    .then(result => {
      stopScanner();
      if (result?.found) {
        askForPermission(null, decodedText);
      } else {
        showError('Nie znaleziono', 'Kod QR jest nieprawid≈Çowy lub wygas≈Ç.');
      }
    })
    .catch(err => {
      console.error(err);
      stopScanner();
      showError('B≈ÇƒÖd sieci/serwera', 'Spr√≥buj ponownie za chwilƒô.');
    });
}

function onScanFailure(_error) {
  // Ignorujemy pojedyncze nieudane ramki
}

async function startScanner() {
  try {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      throw new Error('Strona musi dzia≈Çaƒá przez HTTPS.');
    }

    if (!html5QrCode) html5QrCode = new Html5Qrcode('reader');

    await html5QrCode.start(
      { facingMode: useBackCamera ? 'environment' : 'user' },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      onScanSuccess,
      onScanFailure
    );
  } catch (e) {
    console.error('startScanner error:', e);
    showError('Brak dostƒôpu do kamery', 'Sprawd≈∫ uprawnienia i HTTPS.');
  }
}

async function stopScanner() {
  try { await html5QrCode?.stop(); } catch(_) {}
  try { await html5QrCode?.clear(); } catch(_) {}
}

// üîÅ Prze≈ÇƒÖczanie kamer
async function toggleCamera() {
  useBackCamera = !useBackCamera;
  await stopScanner();
  await startScanner();
}

// üí° Mo≈ºesz dodaƒá przycisk w HTML, np. pod ramkƒÖ:
// <button onclick="toggleCamera()" class="switch-camera">Zmie≈Ñ kamerƒô</button>

// Helper do POST JSON
async function postJson(url, payload) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const ct = res.headers.get('content-type') || '';
  if (!ct.includes('application/json')) throw new Error(`Oczekiwano JSON, otrzymano ${ct}`);
  return res.json();
}

// Rƒôczne wpisanie kodu
document.querySelector('.manual-input').addEventListener('click', () => {
  document.querySelector('.code-input-container').classList.add('active');
  document.querySelector('.code-input-field').focus();
});

function closeCodeInput() {
  document.querySelector('.code-input-container').classList.remove('active');
  setTimeout(() => {
    document.querySelector('.code-input-field').value = '';
    document.querySelector('.code-input-field-container').classList.remove('error');
  }, 300);
}
document.querySelector('.code-input-overlay').addEventListener('click', closeCodeInput);

async function submitCode() {
  const input = document.querySelector('.code-input-field');
  const value = (input.value || '').replace(/\D/g, '').slice(0, 6);
  if (value.length !== 6) return;

  try {
    const result = await postJson('/qr/validate', { code: value });
    closeCodeInput();
    if (result?.found) {
      askForPermission(value, null);
    } else {
      showError('Nie znaleziono', 'Kod jest nieprawid≈Çowy lub wygas≈Ç.');
    }
  } catch (err) {
    console.error(err);
    closeCodeInput();
    showError('B≈ÇƒÖd sieci/serwera', 'Spr√≥buj ponownie za chwilƒô.');
  }
}
window.submitCode = submitCode;

function askForPermission(code, qrCode) {
  if (code) localStorage.setItem('code', code);
  if (qrCode) localStorage.setItem('qrCode', qrCode);
  sendTo('share');
}

// Start scanner po za≈Çadowaniu
document.addEventListener('DOMContentLoaded', startScanner);
</script>
<script src="assets/app/manifest.js"></script>
<script src="assets/app/cache.js"></script>



</body></html>

